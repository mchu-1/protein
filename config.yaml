# =============================================================================
# Protein Binder Design Pipeline - Example Configuration
# =============================================================================
#
# This YAML file configures all pipeline parameters including:
# - Target protein specification
# - Generation mode and parameters
# - Validation thresholds
# - Stage-specific limits (timeouts and max designs)
# - Budget controls
#
# Usage:
#   modal run pipeline.py --config config.yaml
#   python pipeline.py --config config.yaml --dry-run
#
# All fields are optional except 'target'. Defaults are applied for missing values.
# =============================================================================

# Target protein specification (required)
target:
  pdb_id: "3DI3"              # 4-letter PDB code
  entity_id: 2                 # Polymer entity ID (check RCSB for correct entity)
  hotspot_residues:            # Residue indices for binding interface
    - 58
    - 80
    - 139

# Generation mode (optional, default: "bind")
mode: bind

# =============================================================================
# Stage Configurations
# =============================================================================

# RFDiffusion - Backbone Generation
rfdiffusion:
  num_designs: 1200             # Number of backbones to generate
  binder_length_min: 50        # Minimum binder length (residues)
  binder_length_max: 100       # Maximum binder length (residues)
  noise_scale: 1.0             # Diffusion noise scale
  num_diffusion_steps: 50      # Number of diffusion steps

# ProteinMPNN - Sequence Design
proteinmpnn:
  num_sequences: 50            # Sequences per backbone
  temperature: 0.2             # Sampling temperature (lower = more conservative)
  backbone_noise: 0.0          # Backbone coordinate noise

# ESMFold - Orthogonal Validation (Gatekeeper)
esmfold:
  enabled: true                # Enable ESMFold gatekeeper (validates all sequences)
  min_plddt: 70.0              # Min mean pLDDT (confidence)
  max_rmsd: 2.5                # Max RMSD to RFDiffusion backbone (consistency)
  save_predictions: false      # Save ESMFold PDB predictions

# Boltz-2 - Structure Validation (AlphaProteo SI 2.2 thresholds)
boltz2:
  num_recycles: 3              # Number of recycling iterations
  max_pae_interaction: 1.5     # Max PAE at hotspots (Å) - Anchor Lock
  min_ptm_binder: 0.80         # Min pTM for binder-only - Fold Quality
  max_rmsd: 2.5                # Max RMSD vs RFDiffusion (Å) - Self-Consistency

# FoldSeek - Decoy Identification
foldseek:
  database: "pdb100"           # Database to search
  max_hits: 5                  # Maximum decoys (fewer = cheaper Chai-1)
  evalue_threshold: 0.001      # E-value cutoff
  cache_results: true          # Cache decoys by target for reuse

# Chai-1 - Cross-Reactivity Check
chai1:
  num_samples: 1               # Samples per binder-decoy pair
  min_chain_pair_iptm: 0.5     # ipTM threshold for cross-reactivity
  num_recycles: 3              # Number of recycling iterations
  tiered_checking: true        # Use tiered decoy checking for cost savings
  tier1_min_tm: 0.7            # Min TM-score for Tier 1 (highest risk)
  tier2_min_tm: 0.5            # Min TM-score for Tier 2
  tier2_max_decoys: 2          # Max decoys in Tier 2

# =============================================================================
# Clustering & Novelty
# =============================================================================

# TM-score clustering for diversity
cluster:
  tm_threshold: 0.7            # TM-score threshold for clustering
  select_best: true            # Select best representative per cluster

# Novelty check vs UniRef50 (phmmer sequence-vs-sequence search)
# First run downloads ~12GB compressed → ~50GB uncompressed (persisted in Modal Volume)
novelty:
  max_evalue: 0.000001         # Max E-value to consider a hit (1e-6, stricter for IP/safety)
  enabled: true                # Enable novelty filtering
  auto_download: true          # Auto-download UniRef50 database if not present

# =============================================================================
# Scoring Weights
# =============================================================================

scoring:
  alpha: 1.0                   # Weight for interface pLDDT (specificity)
  beta: 0.5                    # Weight for max decoy affinity (selectivity penalty)

# =============================================================================
# Cost Optimization
# =============================================================================

# Backbone quality pre-screening
backbone_filter:
  enabled: true                # Enable backbone quality filtering
  min_score: 0.4               # Min RFDiffusion confidence score
  max_keep: null               # Max backbones to keep (null = no limit)

# Adaptive generation with early termination
adaptive:
  enabled: true               # Enable adaptive generation
  min_validated_candidates: 10  # Stop when this many pass Boltz-2
  batch_size: 4                # Backbones per micro-batch
  max_batches: 3               # Maximum micro-batches

# Solubility filter (1D chemistry gates)
solubility_filter:
  enabled: true
  min_abs_charge_ph7: 3.0      # Min |net charge| - prevents clumping
  max_abs_charge_ph7: 12.0     # Max |net charge| - rejects super-charged sludge
  forbidden_pi_min: 6.0        # Forbidden pI zone lower bound (dead zone)
  forbidden_pi_max: 8.0        # Forbidden pI zone upper bound (near pH 7.4)

# Stickiness filter (3D structure gates)
stickiness_filter:
  enabled: true
  max_sap_score: 0.50          # Relaxed to allow CDR-like loops
  hydrophobic_residues: "AVILMFYW"

# Structural memoization (3Di fingerprinting)
structural_memoization:
  enabled: true
  similarity_threshold: 0.9    # Skip structural twins above this similarity
  cache_ttl_hours: 168         # 7-day cache TTL

# Beam pruning (tree width control)
beam_pruning:
  enabled: true
  max_tree_nodes: 75000          # Maximum total nodes in state tree
  sequences_per_backbone: 150   # Max sequences per backbone
  predictions_per_sequence: 1  # Max predictions per sequence
  prune_by_score: true         # Prune lowest-scoring siblings

# =============================================================================
# Stage Limits
# =============================================================================
#
# Limits define the worst-case duration (timeout) for each stage of the pipeline.
# Used for cost forecasting and enforcing execution time boundaries.
# Timeouts are in seconds.

limits:
  rfdiffusion:
    timeout_seconds: 600       # 10 minutes for batch generation
  
  proteinmpnn:
    timeout_seconds: 300       # 5 minutes per backbone
  
  esmfold:
    timeout_seconds: 300       # 5 minutes per sequence validation
  
  boltz2:
    timeout_seconds: 900       # 15 minutes per validation
  
  foldseek:
    timeout_seconds: 120       # 2 minutes for proteome search
  
  chai1:
    timeout_seconds: 900       # 15 minutes per pair

# =============================================================================
# Budget Control (Optional)
# =============================================================================

# Maximum compute budget in USD (optional - remove or set to null to disable)
# max_compute_usd: 10.0
